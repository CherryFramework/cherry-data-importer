!function(e,a){"use strict";a={selectors:{trigger:"#cherry-import-start",advancedTrigger:'button[data-action="start-install"]',popupTrigger:'button[data-action="confirm-install"]',removeContent:'button[data-action="remove-content"]',upload:"#cherry-file-upload",globalProgress:"#cherry-import-progress"},globalProgress:null,init:function(){e(function(){a.globalProgress=e(a.selectors.globalProgress).find(".cdi-progress__bar"),e("body").on("click.cdiImport",a.selectors.trigger,a.goToImport).on("click.cdiImport",a.selectors.advancedTrigger,a.advancedImport).on("click.cdiImport",a.selectors.popupTrigger,a.confirmImport).on("click.cdiImport",a.selectors.removeContent,a.removeContent).on("focus.cdiImport",".cdi-remove-form__input",a.clearRemoveNotices).on("change.cdiImport",'input[name="install-type"]',a.advancedNotice).on("click.cdiImport",".cdi-advanced-popup__close",a.closePopup),window.CherryDataImportVars.autorun&&a.startImport(),void 0!==window.CherryRegenerateData&&a.regenerateThumbnails(),a.fileUpload()})},removeContent:function(){var t=e(this),r=t.prev(),o=t.closest(".cdi-remove-form"),s=e(".cdi-remove-form__notices",o),i={};t.hasClass("in-progress")||(i.action="cherry-data-import-remove-content",i.nonce=window.CherryDataImportVars.nonce,i.password=r.val(),t.addClass("in-progress"),e.ajax({url:window.ajaxurl,type:"post",dataType:"json",data:i,error:function(){t.removeClass("in-progress")}}).done(function(e){1==e.success?(o.addClass("content-removed").html(e.data.message),a.startImport()):(s.addClass("cdi-error").removeClass("cdi-hide"),s.html(e.data.message)),t.removeClass("in-progress")}))},clearRemoveNotices:function(){var a=e(this),t=a.closest(".cdi-remove-form"),r=e(".cdi-remove-form__notices",t);r.removeClass("cdi-error").addClass("cdi-hide")},closePopup:function(){e(".cdi-advanced-popup").addClass("popup-hidden").data("url",null),e(".cdi-btn.in-progress").removeClass("in-progress")},confirmImport:function(){var a=e(this),t=a.closest(".cdi-advanced-popup"),r=e('.cdi-advanced-popup__item input[type="radio"]:checked',t),o="append",s=t.data("url");a.addClass("in-progress"),console.log(r),void 0!==r.val()&&""!==r.val()&&(o=r.val()),s=s+"&type="+o,window.location=s},advancedImport:function(){var a=e(this),t=a.closest(".advanced-item"),r=e('.advanced-item__type-checkbox input[type="checkbox"]',t),o=window.CherryDataImportVars.advURLMask,s=t.data("full"),i=t.data("min");a.addClass("in-progress"),o=r.is(":checked")?o.replace("<-file->",i):o.replace("<-file->",s),e(".cdi-advanced-popup").removeClass("popup-hidden").data("url",o)},advancedNotice:function(){var a=e(this),t=a.closest(".cdi-advanced-popup__content"),r=e(".cdi-advanced-popup__warning",t);a.is(":checked")&&"replace"===a.val()?r.removeClass("cdi-hide"):r.hasClass("cdi-hide")||r.addClass("cdi-hide")},regenerateThumbnails:function(){var e={action:"cherry-regenerate-thumbnails",offset:0,step:window.CherryRegenerateData.step,total:window.CherryRegenerateData.totalSteps};a.ajaxRequest(e)},ajaxRequest:function(t){var r;t.nonce=window.CherryDataImportVars.nonce,t.file=window.CherryDataImportVars.file,e.ajax({url:window.ajaxurl,type:"get",dataType:"json",data:t,error:function(){t.step?(r=Math.ceil(100*(t.offset+t.step)/(t.total*t.step)),a.globalProgress.css("width",r+"%").find(".cdi-progress__label").text(r+"%"),t.offset=t.offset+t.step,a.ajaxRequest(t)):e("#cherry-import-progress").replaceWith('<div class="import-failed">'+window.CherryDataImportVars.error+"</div>")}}).done(function(t){!0!==t.success||t.data.isLast||a.ajaxRequest(t.data),t.data&&t.data.redirect&&(window.location=t.data.redirect),t.data&&t.data.complete&&(a.globalProgress.css("width",t.data.complete+"%").find(".cdi-progress__label").text(t.data.complete+"%"),a.globalProgress.siblings(".cdi-progress__placeholder").remove()),t.data&&t.data.processed&&e.each(t.data.processed,a.updateSummary)})},updateSummary:function(a,t){var r=e('tr[data-item="'+a+'"]'),o=parseInt(r.data("total")),s=e(".cdi-install-summary__done",r),i=e(".cdi-install-summary__percent",r),n=e(".cdi-progress__bar",r),d=Math.round(parseInt(t)/o*100);s.html(t),i.html(d),n.css("width",d+"%")},startImport:function(){var e={action:"cherry-data-import-chunk",chunk:1};a.ajaxRequest(e)},prepareImportArgs:function(){var a=null,t=e('input[name="upload_file"]'),r=e('select[name="import_file"]');return t.length&&""!==t.val()&&(a=t.val()),r.length&&null==a&&(a=e("option:selected",r).val()),"&tab="+window.CherryDataImportVars.tab+"&step=2&file="+a},goToImport:function(){var t=e('input[name="referrer"]').val();e(this).hasClass("disabled")||(window.location=t+a.prepareImportArgs())},fileUpload:function(){var t=e(a.selectors.upload),r=t.closest(".import-file"),o=r.find(".import-file__placeholder"),s=r.find(".import-file__input"),i=wp.media.frames.file_frame=wp.media({title:window.CherryDataImportVars.uploadTitle,button:{text:window.CherryDataImportVars.uploadBtn},multiple:!1}),n=function(){return i.open(),!1},d=function(){var e=i.state().get("selection").toJSON(),t=e[0];o.val(t.url),a.getFilePath(t.url,s)};t.on("click",n),i.on("select",d)},getFilePath:function(t,r){var o=e(a.selectors.trigger);o.addClass("disabled"),e.ajax({url:window.ajaxurl,type:"get",dataType:"json",data:{action:"cherry-data-import-get-file-path",file:t,nonce:window.CherryDataImportVars.nonce},error:function(){return o.removeClass("disabled"),!1}}).done(function(e){o.removeClass("disabled"),!0===e.success&&r.val(e.data.path)})}},a.init()}(jQuery,window.CherryDataImport);